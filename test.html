<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Cairo", sans-serif;
}

body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #222;
  min-height: 100vh;
}

#lock-screen {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  z-index: 9999;
}

.lock-box {
  background: #fff;
  width: 90%;
  max-width: 400px;
  padding: 40px 30px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.4s ease;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(40px); }
  to { opacity: 1; transform: translateY(0); }
}

.lock-box h2 {
  color: #667eea;
  margin-bottom: 10px;
  font-size: 1.8em;
}

.lock-box p {
  font-size: 0.95em;
  color: #666;
  margin-bottom: 30px;
}

.lock-row {
  margin-bottom: 15px;
  position: relative;
}

.lock-row input {
  width: 100%;
  padding: 14px 16px;
  border-radius: 12px;
  border: 2px solid #e0e7ff;
  background: #f8f9ff;
  text-align: center;
  font-size: 1.1em;
  transition: all 0.3s ease;
}

.lock-row input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.lock-toggle {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 1.3em;
}

.lock-box button {
  margin-top: 20px;
  width: 100%;
  padding: 13px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 1.05em;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
}

.lock-box button:hover {
  transform: translateY(-2px);
}

.lock-error {
  margin-top: 15px;
  background: #ffebee;
  color: #c62828;
  padding: 10px;
  font-weight: 700;
  display: none;
  border-radius: 10px;
}

.hidden { display: none !important; }

.dashboard {
  max-width: 1400px;
  margin: auto;
  padding: 25px;
}

.dash-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 30px;
  background: rgba(255, 255, 255, 0.95);
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.dash-title {
  font-size: 2.2em;
  font-weight: 900;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.dash-subtitle {
  font-size: 0.95em;
  color: #999;
}

.admin-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 8px 14px;
  border-radius: 50px;
  color: #fff;
  font-weight: 700;
  font-size: 0.9em;
}

.live-badge {
  background: linear-gradient(135deg, #d4fc79 0%, #96f97b 100%);
  padding: 10px 18px;
  border-radius: 50px;
  color: #2d5016;
  font-weight: 700;
  display: flex;
  gap: 8px;
  align-items: center;
}

.live-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #2d5016;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

#spike-alert {
  display: none;
  background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
  padding: 15px;
  color: #fff;
  border-radius: 12px;
  font-weight: 800;
  text-align: center;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.card {
  background: rgba(255, 255, 255, 0.95);
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.card:hover {
  transform: translateY(-8px);
  box-shadow: 0 16px 48px rgba(102, 126, 234, 0.2);
}

.card-title {
  font-size: 0.85em;
  color: #999;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

.card-value {
  font-size: 2.2em;
  font-weight: 900;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-top: 10px;
}

.card-note {
  font-size: 0.75em;
  color: #bbb;
  margin-top: 8px;
}

.committee-stats-card {
  background: rgba(255, 255, 255, 0.95);
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  margin-bottom: 25px;
}

.committee-stats-card h3 {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.2em;
  margin-bottom: 20px;
  font-weight: 900;
}

.committee-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
  padding: 5px;
}

.committee-item {
  background: linear-gradient(135deg, #f5f7ff 0%, #eff2ff 100%);
  padding: 15px;
  border-radius: 12px;
  transition: all 0.3s ease;
  cursor: pointer;
  border-left: 4px solid #667eea;
}

.committee-item:hover {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  transform: scale(1.05);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}

.committee-num {
  font-size: 1.1em;
  font-weight: 900;
  margin-bottom: 8px;
}

.committee-name {
  font-size: 0.85em;
  font-weight: 700;
  margin-bottom: 4px;
  opacity: 0.9;
}

.committee-address {
  font-size: 0.75em;
  opacity: 0.8;
  margin-bottom: 8px;
}

.committee-count {
  font-size: 0.8em;
  opacity: 0.8;
}

.notify-panel {
  background: rgba(255, 255, 255, 0.95);
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  margin-bottom: 25px;
}

.notify-panel h3 {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.2em;
  margin-bottom: 20px;
  font-weight: 900;
}

.notify-option {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
  font-weight: 600;
  color: #333;
}

.notify-panel textarea {
  width: 100%;
  min-height: 100px;
  padding: 14px;
  background: #f8f9ff;
  border: 2px solid #e0e7ff;
  border-radius: 12px;
  margin-bottom: 15px;
  font-size: 1em;
  resize: vertical;
  transition: all 0.3s ease;
  font-family: "Cairo", sans-serif;
}

.notify-panel textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

#notify-result {
  display: none;
  margin-top: 12px;
  font-weight: 800;
  font-size: 0.95em;
  padding: 12px;
  border-radius: 10px;
}

.charts-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
  margin-bottom: 25px;
}

.chart-card {
  background: rgba(255, 255, 255, 0.95);
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
}

.chart-card:hover {
  box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
}

.chart-card h3 {
  margin-bottom: 18px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.05em;
  font-weight: 900;
}

.chart-container {
  position: relative;
  height: 320px;
}

.ranking-card {
  background: rgba(255, 255, 255, 0.95);
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  margin-bottom: 25px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}

.ranking-card h3 {
  margin-bottom: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.2em;
  font-weight: 900;
}

.ranking-list {
  max-height: 500px;
  overflow-y: auto;
  padding: 5px;
}

.ranking-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding: 15px;
  background: linear-gradient(135deg, #f5f7ff 0%, #eff2ff 100%);
  border-radius: 12px;
  transition: all 0.3s;
  border-left: 4px solid #667eea;
}

.ranking-item:hover {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  transform: translateX(-5px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}

.ranking-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.ranking-medal {
  font-size: 1.6em;
  min-width: 35px;
  text-align: center;
}

.ranking-name {
  font-weight: 700;
}

.ranking-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.ranking-bar {
  height: 28px;
  border-radius: 14px;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 0.85em;
  font-weight: 700;
  min-width: 80px;
}

.ranking-count {
  font-weight: 900;
  min-width: 45px;
  text-align: center;
}

.table-card {
  background: rgba(255, 255, 255, 0.95);
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 18px;
}

.search-input {
  padding: 12px 16px;
  border-radius: 12px;
  border: 2px solid #e0e7ff;
  background: #f8f9ff;
  min-width: 220px;
  font-size: 0.95em;
  transition: all 0.3s ease;
}

.search-input:focus {
  outline: none;
  border-color: #667eea;
}

.btn-sm {
  padding: 11px 18px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.9em;
  transition: all 0.3s ease;
}

.btn-sm:hover {
  transform: translateY(-2px);
}

.btn-export {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
}

.btn-reset-all {
  background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%) !important;
}

.btn-hidden {
  display: none !important;
}

.table-wrap {
  max-height: 450px;
  overflow: auto;
  border: 1px solid #e0e7ff;
  border-radius: 12px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9em;
}

thead {
  background: linear-gradient(135deg, #f5f7ff 0%, #eff2ff 100%);
  position: sticky;
  top: 0;
  z-index: 10;
}

th, td {
  padding: 12px 14px;
  border-bottom: 1px solid #e8ecff;
}

th {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  cursor: pointer;
  font-weight: 900;
  user-select: none;
}

tr:hover td {
  background: rgba(102, 126, 234, 0.05);
}

.status-valid {
  color: #11998e;
  font-weight: 900;
}

.status-invalid {
  color: #eb3349;
  font-weight: 900;
}

.clickable-name {
  text-decoration: underline;
  cursor: pointer;
  color: #667eea;
}

.vote-status-friend {
  display: inline-block;
  padding: 5px 10px;
  background: linear-gradient(135deg, #d4fc79 0%, #96f97b 100%);
  color: #2d5016;
  border-radius: 8px;
  font-size: 0.8em;
  font-weight: 700;
}

.vote-status-enemy {
  display: inline-block;
  padding: 5px 10px;
  background: linear-gradient(135deg, #ffb347 0%, #ffcc99 100%);
  color: #5c2e0f;
  border-radius: 8px;
  font-size: 0.8em;
  font-weight: 700;
}

.btn-mini-edit {
  padding: 6px 12px;
  border-radius: 8px;
  background: #667eea;
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.8em;
  transition: all 0.3s ease;
}

.btn-mini-edit:hover {
  background: #764ba2;
}

.footer-note {
  margin-top: 12px;
  color: #999;
  font-size: 0.85em;
  font-weight: 600;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9000;
  backdrop-filter: blur(5px);
}

.overlay.hidden {
  display: none !important;
}

.popup {
  background: #fff;
  width: 92%;
  max-width: 500px;
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-height: 85vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}

.popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 900;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 18px;
  font-size: 1.2em;
}

.popup-close {
  background: none;
  border: none;
  font-size: 1.5em;
  cursor: pointer;
  color: #667eea;
  transition: all 0.3s ease;
}

.popup-close:hover {
  transform: scale(1.2);
}

.edit-list {
  max-height: 280px;
  overflow: auto;
  border: 2px solid #e0e7ff;
  border-radius: 12px;
  padding: 12px;
  background: #f8f9ff;
}

.edit-list label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 8px 0;
  font-weight: 700;
  color: #333;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.edit-list label:hover {
  background: #eff2ff;
}

.edit-list input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #667eea;
  cursor: pointer;
}

@media(max-width: 900px) {
  .charts-grid { grid-template-columns: 1fr; }
  .committee-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
  .dash-header { flex-direction: column; }
}

@media(max-width: 600px) {
  .dashboard { padding: 15px; }
  .dash-title { font-size: 1.6em; }
  .committee-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
  .table-header { flex-direction: column; align-items: flex-start; }
  .search-input { min-width: 100%; }
}
</style>
</head>
<body>

<div id="lock-screen">
  <div class="lock-box">
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <p>Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© VIP Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·</p>
    <div class="lock-row">
      <input id="lock-pass" type="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="off">
      <span class="lock-toggle" onclick="toggleLockPass()">ğŸ‘</span>
    </div>
    <button onclick="unlockDashboard()">Ø¯Ø®ÙˆÙ„</button>
    <div id="lock-error" class="lock-error"></div>
  </div>
</div>

<div id="dashboard" class="dashboard hidden">
  <div class="dash-header">
    <div>
      <div class="dash-title">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¥Ù†ØªØ®Ø§Ø¨ÙŠØ© | Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…Ù†Ø²Ù„Ø© ÙˆØ§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</div>
      <div class="dash-subtitle">Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ù†ÙˆØ¹Ù‡ ÙÙ‰ Ù…ØµØ±</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <div class="live-badge">
        <span class="live-dot"></span>
        <span id="live-status">Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</span>
      </div>
      <div id="admin-level-badge" class="admin-badge"></div>
    </div>
  </div>

  <div id="spike-alert">ØªÙ†Ø¨ÙŠÙ‡: Ù‚ÙØ²Ø© Ø¹Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª!</div>

  <div class="cards">
    <div class="card">
      <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©</div>
      <div id="total-original-voters" class="card-value">350757</div>
      <div class="card-note">Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©</div>
    </div>
    <div class="card">
      <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
      <div id="total-votes" class="card-value">0</div>
      <div class="card-note">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
    </div>
    <div class="card">
      <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
      <div id="remaining-voters" class="card-value">350757</div>
      <div class="card-note">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ - Ø§Ù„Ù…Ø³Ø¬Ù„</div>
    </div>
    <div class="card">
      <div class="card-title">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
      <div id="valid-votes" class="card-value">0</div>
      <div class="card-note">ØµØ­ÙŠØ­</div>
    </div>
    <div class="card">
      <div class="card-title">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨Ø§Ø·Ù„Ø©</div>
      <div id="invalid-votes" class="card-value">0</div>
      <div class="card-note">Ø¨Ø§Ø·Ù„</div>
    </div>
    <div class="card">
      <div class="card-title">Ù…ØªÙˆØ³Ø· Ø£ØµÙˆØ§Øª/Ø¯Ù‚ÙŠÙ‚Ø©</div>
      <div id="vpm" class="card-value">0</div>
      <div class="card-note">Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div>
    </div>
    <div class="card">
      <div class="card-title">Ø¢Ø®Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚</div>
      <div id="vpm10" class="card-value">0</div>
      <div class="card-note">Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
    </div>
  </div>

  <div class="committee-stats-card">
    <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù„Ø¬Ø§Ù†</h3>
    <div id="committee-grid" class="committee-grid">
      <div style="padding:20px;text-align:center;color:#999;grid-column:1/-1">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <div class="notify-panel">
    <h3>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
    <label class="notify-option">
      <input type="radio" name="notify-target" value="all" checked>
      <span>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø¬Ø§Ù†</span>
    </label>
    <label class="notify-option">
      <input type="radio" name="notify-target" value="one">
      <span>Ù„Ø¬Ù†Ø© Ø±Ù‚Ù…:
        <input id="notify-committee" type="number" min="1" max="60" value="1" style="width:80px; padding:6px; border-radius:8px; border:2px solid #e0e7ff;">
      </span>
    </label>
    <textarea id="notify-message" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
    <button class="btn-sm" style="width:100%;margin-top:8px" onclick="sendNotification()">Ø§Ø±Ø³Ø§Ù„</button>
    <div id="notify-result"></div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <h3>Ø§Ù„Ø£ØµÙˆØ§Øª Ù„ÙƒÙ„ Ù…Ø±Ø´Ø­</h3>
      <div class="chart-container">
        <canvas id="chartCandidates"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <h3>Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ø¨Ø§Ø·Ù„</h3>
      <div class="chart-container">
        <canvas id="chartValidity"></canvas>
      </div>
    </div>
  </div>

  <div class="chart-card">
    <h3>Ø§Ù„Ø£ØµÙˆØ§Øª Ù„ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©</h3>
    <div class="chart-container">
      <canvas id="chartVPM"></canvas>
    </div>
  </div>

  <div class="ranking-card">
    <h3>ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h3>
    <div id="ranking-list" class="ranking-list">
      <div style="padding:20px;text-align:center;color:#999">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <div class="table-card">
    <div class="table-header">
      <input id="search" class="search-input" placeholder="Ø¨Ø­Ø«...">
      <div style="display:flex; gap:8px;">
        <button class="btn-sm btn-export" onclick="exportCSV()">ØªØµØ¯ÙŠØ± CSV</button>
        <button id="btn-reset-all" class="btn-sm btn-reset-all" onclick="resetAll()">ØªØµÙÙŠØ±</button>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th data-sort="index">#</th>
            <th data-sort="name">Ø§Ù„Ø§Ø³Ù…</th>
            <th data-sort="candidates">Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</th>
            <th data-sort="validity">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª</th>
            <th data-sort="time">Ø§Ù„ÙˆÙ‚Øª</th>
            <th id="edit-col">ØªØ¹Ø¯ÙŠÙ„</th>
          </tr>
        </thead>
        <tbody id="votes-table"></tbody>
      </table>
    </div>
    <div id="footer-note" class="footer-note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
  </div>
</div>

<div id="details-popup" class="overlay hidden">
  <div class="popup">
    <div class="popup-header">
      <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø§Ø®Ø¨</h3>
      <button class="popup-close" onclick="closeDetails()">x</button>
    </div>
    <div id="details-body" style="padding:10px;"></div>
  </div>
</div>

<div id="committee-popup" class="overlay hidden">
  <div class="popup">
    <div class="popup-header">
      <h3 id="committee-popup-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø¬Ù†Ø©</h3>
      <button class="popup-close" onclick="closeCommitteePopup()">x</button>
    </div>
    <div id="committee-popup-body" style="padding:10px;"></div>
  </div>
</div>

<div id="edit-popup" class="overlay hidden">
  <div class="popup">
    <div class="popup-header">
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h3>
      <button class="popup-close" onclick="closeEdit()">x</button>
    </div>
    <div style="padding:10px;">
      <p id="edit-name" style="font-weight:700;margin-bottom:10px;"></p>
      <div id="edit-candidates" class="edit-list"></div>
      <button class="btn-sm" style="width:100%;margin-top:12px;" onclick="saveEdit()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCxxXV_6CEo1fTp3rRbfwfYbe7WH0Cyg38",
  authDomain: "elahmadiya.firebaseapp.com",
  databaseURL: "https://elahmadiya-default-rtdb.firebaseio.com",
  projectId: "elahmadiya",
  storageBucket: "elahmadiya.firebasestorage.app",
  messagingSenderId: "594580767620",
  appId: "1:594580767620:web:f5be3b87d4c704854e53d1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allVotes = [];
let sortState = { key: "index", dir: "asc" };
let chartCandidates = null;
let chartValidity = null;
let chartVPM = null;
let adminLevel = 0;

const committeeData = {
  1:  { name: "Ø§Ù„ÙØ±ÙˆØ³Ø§Øª", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ø­Ù…Ø¯ Ø§Ù„Ù‚ØµØ¨Ù‰ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  2:  { name: "Ø§Ù„ÙØ±ÙˆØ³Ø§Øª", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ø­Ù…Ø¯ Ø§Ù„Ù‚ØµØ¨Ù‰ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  3:  { name: "Ø£Ø¨Ùˆ Ø§Ù„Ø£Ø®Ø¶Ø±", address: "Ù…Ø¯Ø±Ø³Ø© Ø£Ø¨Ùˆ Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  4:  { name: "Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ù†Ø²Ù„Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù…Ø­Ù…Ø¯ ÙÙˆØ²Ù‰" },
  5:  { name: "Ø§Ù„Ø¹Ø§Ù…Ø±Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø±Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  6:  { name: "Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ù†Ø²Ù„Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø¹Ø¨Ø¯Ù‡ Ø¨Ø·ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  7:  { name: "Ø¹Ø±Ø¨ Ø²ÙŠØ¯Ø§Ù†", address: "Ù…Ø¯Ø±Ø³Ø© Ø¹Ø±Ø¨ Ø²ÙŠØ¯Ø§Ù† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  8:  { name: "Ø§Ù„Ø³ØªØ§ÙŠØªØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù…Ø­Ù…Ø¯ Ø²ØºÙ„ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  9:  { name: "ÙƒÙØ± Ø­Ø¬Ø§Ø¬", address: "Ù…Ø¯Ø±Ø³Ø© ÙƒÙØ± Ø­Ø¬Ø§Ø¬ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  10: { name: "Ù…ÙŠØª Ø®Ø¶", address: "Ù…Ø¯Ø±Ø³Ø© Ù…Ø­Ù…Ø¯ Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  11: { name: "Ø§Ù„Ù…ÙˆØ§Ø¬Ø¯Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø­Ø³Ù†ÙŠ Ø§Ù„Ø´Ù†Ø§ÙˆÙ‰" },
  12: { name: "Ø§Ù„Ø¨Ø¶Ø§Ø·", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙ‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  13: { name: "Ø§Ù„Ø¨Ø¶Ø§Ø·", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙ‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  14: { name: "Ø§Ù„Ø·ÙˆØ§Ø¨Ø±Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†ØµØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  15: { name: "Ø§Ù„Ø¹Ù…Ø§Ø±Ù†Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¹Ù…Ø§Ø±Ù†Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  16: { name: "Ø£ÙˆÙ„Ø§Ø¯ Ø¨Ø§Ù†Ø§", address: "Ù…Ø¯Ø±Ø³Ø© Ø£ÙˆÙ„Ø§Ø¯ Ø¨Ø§Ù†Ø§ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  17: { name: "Ø£ÙˆÙ„Ø§Ø¯ Ø­Ø§Ù†Ø§", address: "Ù…Ø¯Ø±Ø³Ø© Ø£ÙˆÙ„Ø§Ø¯ Ø­Ø§Ù†Ø§ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  18: { name: "Ø§Ù„Ù‚Ø²Ø§Ù‚Ø²Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù‚Ø²Ø§Ù‚Ø²Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  19: { name: "Ø§Ù„Ø­ÙˆØªÙ‡", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ø§Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯" },
  20: { name: "Ø£ÙˆÙ„Ø§Ø¯ Ù†ÙˆØ±", address: "Ù…Ø¯Ø±Ø³Ø© Ø£ÙˆÙ„Ø§Ø¯ Ù†ÙˆØ± Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  21: { name: "Ø§Ù„Ø®Ù„Ø§ÙŠÙØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù…Ø­Ù…ÙˆØ¯ ÙÙ‡ÙŠÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  22: { name: "Ø§Ù„Ù‚Ø·Ø´Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù‚Ø·Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  23: { name: "Ø§Ù„Ø¬Ù…Ø§Ù…Ù„Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬Ù…Ø§Ù…Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  24: { name: "Ø§Ù„Ø¹Ø²ÙŠØ²Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  25: { name: "Ø§Ù„Ø¹Ø²ÙŠØ²Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  26: { name: "Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø§Ø­Ù…Ø¯ÙŠØ© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  27: { name: "Ø§Ù„Ø¹Ø±Ø¨Ø§Ù†", address: "Ù…Ø¯Ø±Ø³Ø© Ø·Ø§Ù‡Ø± ÙØ±Ø­" },
  28: { name: "Ø£ÙˆÙ„Ø§Ø¯ Ø¹Ù„Ù…", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù†ÙŠ Ø³Ù„ÙŠÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  29: { name: "Ø£ÙˆÙ„Ø§Ø¯ Ù†Ø§ØµØ±", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¯ÙƒØªÙˆØ± Ù…Ø­Ù…Ø¯ Ø§Ù„Ù†Ø­Ø§Ø³" },
  30: { name: "Ø¨Ø¨Ø± Ù‡Ù„Ø§Ù„", address: "Ù…Ø¯Ø±Ø³Ø© Ø¨Ø¨Ø± Ù‡Ù„Ø§Ù„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  31: { name: "Ø§Ù„Ø´Ø¨ÙˆÙ„", address: "Ù…Ø¹Ù‡Ø¯ Ø¨Ù†ÙŠ Ø§Ù„Ø´Ø¨ÙˆÙ„ Ø§Ù„Ø£Ø²Ù‡Ø±Ù‰" },
  32: { name: "Ø§Ù„Ø´Ø¨ÙˆÙ„", address: "Ù…Ø¹Ù‡Ø¯ Ø¨Ù†ÙŠ Ø§Ù„Ø´Ø¨ÙˆÙ„ Ø§Ù„Ø£Ø²Ù‡Ø±Ù‰" },
  33: { name: "Ø§Ù„Ø±ÙˆØ¯Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±ÙˆØ¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  34: { name: "Ù…ÙŠØª Ø´Ø±ÙŠÙ", address: "Ù…Ø¯Ø±Ø³Ø© Ø£Ù… Ø§Ù„Ù…Ø¤Ù…Ù†ÙŠÙ† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  35: { name: "Ø¨Ø­Ø± Ø­Ø§Ø¯ÙˆØ«", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø³ÙŠØ¯ Ù‚Ø·Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  36: { name: "Ø§Ù„Ù†Ø³Ø§ÙŠÙ…Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†Ø³Ø§ÙŠÙ…Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  37: { name: "Ø§Ù„Ù†Ø³Ø§ÙŠÙ…Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†Ø³Ø§ÙŠÙ…Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  40: { name: "Ø´Ø§Ø±Ø¹ Ù…Ø­Ù…Ø¯ ÙØ±ÙŠØ¯", address: "Ù…Ø¹Ù‡Ø¯ ÙØªÙŠØ§Øª Ø§Ù„Ù…Ø·Ø±ÙŠØ© Ø¹ Ø«" },
  41: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…ÙŠÙ†Ø§ Ø§Ù„Ù‚Ø¨Ù„ÙŠ", address: "Ù…Ø¯Ø±Ø³Ø© Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„ØµØ¯ÙŠÙ‚" },
  42: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ø£Ø­Ù…Ø¯ Ù…Ø§Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ù†ÙŠÙ†" },
  43: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ø£Ø­Ù…Ø¯ Ù…Ø§Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ù†ÙŠÙ†" },
  44: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…ÙŠÙ†Ø§ Ø§Ù„Ø¨Ø­Ø±ÙŠ", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¹Ø§Ø´Ø± Ù…Ù† Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  45: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…ÙŠÙ†Ø§ Ø§Ù„Ø¨Ø­Ø±ÙŠ", address: "Ù…Ø¯Ø±Ø³Ø© Ø·Ø§Ø±Ù‚ Ø§Ø¨Ù† Ø²ÙŠØ§Ø¯ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  46: { name: "Ù‚Ø±ÙŠØ© Ø§Ù„Ø¹ØµØ§ÙØ±Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø³ÙŠØ¯Ø© Ù†ÙØ³ÙŠØ© Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠØ© Ø¨Ù†Ø§Øª" },
  47: { name: "Ù‚Ø±ÙŠØ© Ø§Ù„Ø¹ØµØ§ÙØ±Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø³ÙŠØ¯Ø© Ù†ÙØ³ÙŠØ© Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠØ© Ø¨Ù†Ø§Øª" },
  48: { name: "Ù‚Ø±ÙŠØ© Ø§Ù„Ø¶Ù‡ÙŠØ±", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¶Ù‡ÙŠØ± Ø§Ù„Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  49: { name: "Ø´Ø§Ø±Ø¹ ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†", address: "Ù…Ø¹Ù‡Ø¯ Ø¹Ø«Ù…Ø§Ù† Ø¨Ù† Ø¹ÙØ§Ù† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" },
  50: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ø®Ø§Ù„Ø¯ Ø¨Ù† Ø§Ù„ÙˆÙ„ÙŠØ¯" },
  51: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ø®Ø§Ù„Ø¯ Ø¨Ù† Ø§Ù„ÙˆÙ„ÙŠØ¯" },
  52: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…ÙŠÙ†Ø§ Ø§Ù„Ø¨Ø­Ø±ÙŠ", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø·Ø±ÙŠØ© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  53: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ù†ÙŠÙ†" },
  54: { name: "Ø´Ø§Ø±Ø¹ Ù…ØµÙ†Ø¹ Ø§Ù„Ø¨ØµÙ„", address: "Ù…Ø¯Ø±Ø³Ø© Ø¹Ø«Ù…Ø§Ù† Ø¨Ù† Ø¹ÙØ§Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  55: { name: "Ø´Ø§Ø±Ø¹ Ù…ØµÙ†Ø¹ Ø§Ù„Ø¨ØµÙ„", address: "Ù…Ø¯Ø±Ø³Ø© Ø¹Ø«Ù…Ø§Ù† Ø¨Ù† Ø¹ÙØ§Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" },
  56: { name: "Ø´Ø§Ø±Ø¹ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  57: { name: "Ù‡Ø§Ø´Ù… Ø´Ù„Ø¨Ø§ÙŠØ©", address: "Ù…Ø¯Ø±Ø³Ø© Ù‡Ø§Ø´Ù… Ø´Ù„Ø¨Ø§ÙŠØ© Ø®Ù„Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰" },
  58: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  59: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  60: { name: "Ø³ÙˆÙ‚ Ø§Ù„Ø¬Ù…Ø¹Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø§Ù…Ø§Ù… Ø¹Ù„ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  38: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø«ÙˆØ±Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ù†Ø¬Ø¯ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ù†Ø§Øª" },
  39: { name: "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø«ÙˆØ±Ø©", address: "Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ù†Ø¬Ø¯ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ù†Ø§Øª" }
};
  
const originalVotersCount = {
  1: 5929, 2: 5554, 3: 4617, 4: 9197, 5: 3519, 6: 3781,
  7: 1848, 8: 2239, 9: 2689, 10: 2204, 11: 4891, 12: 9075,
  13: 8966, 14: 4194, 15: 9886, 16: 1892, 17: 4334, 18: 2239,
  19: 4400, 20: 2290, 21: 1904, 22: 2052, 23: 1868, 24: 10131,
  25: 10191, 26: 4683, 27: 560, 28: 1342, 29: 1642, 30: 3328,
  31: 6250, 32: 5863, 33: 5498, 34: 5498, 35: 9792, 36: 7021,
  37: 6121, 38: 7446, 39: 7447, 40: 8538, 41: 7310, 42: 8793,
  43: 8793, 44: 7721, 45: 7421, 46: 9704, 47: 9704, 48: 3119,
  49: 8214, 50: 6247, 51: 6247, 52: 6600, 53: 10721, 54: 7871,
  55: 8436, 56: 9689, 57: 10055, 58: 6975, 59: 5580, 60: 10989
};

const totalOriginalVoters = 350757;

const candidatesNames = [
  "Ø§ÙŠÙ‡Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø¯Ù‡","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙ…Ø§Ù†Ù‰","Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰",
  "Ø¹Ø§Ø¯Ù„ Ø§Ù„Ø¬ÙŠØ§Ø±","Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø³Ù…Ø±Ù‡","ÙˆÙ„ÙŠØ¯ ØªÙŠØ³ÙŠØ± Ø§Ù„Ø§Ù…ÙŠØ±",
  "ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹ÙŠØ³ÙˆÙ‰","Ø§Ù„Ø¨Ø¯ÙˆÙ‰ Ø¬Ù…ÙŠØ²","Ø§Ø­Ù…Ø¯ Ø§Ù„Ø±ÙŠØ³",
  "Ø£Ø­Ù…Ø¯ Ø¹ÙˆÙ","Ø­Ø³Ù† Ø§Ù„Ù…Ù„Ù‡Ø§Ø·","Ø¹Ù…Ø±Ùˆ Ù…Ø­Ù…Ø¯ Ø¨Ø­ÙŠØ±Ù‰",
  "Ø§Ù„Ø³ÙŠØ¯ Ø·Ù…Ø§Ù†","Ù…Ø­Ù…Ø¯ Ø¯Ù†Ø¯Ù†","Ù…Ø¬Ø¯Ù‰ Ø§Ù„Ø£Ù…ÙŠØ±"
];

window.toggleLockPass = function(){
  const inp = document.getElementById("lock-pass");
  inp.type = inp.type === "password" ? "text" : "password";
};

window.unlockDashboard = function(){
  const value = document.getElementById("lock-pass").value.trim();
  const err = document.getElementById("lock-error");
  
  if(value === "251988"){
    adminLevel = 1;
    document.getElementById("lock-screen").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("admin-level-badge").textContent = "ğŸ”‘ Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯";
    showNotification("Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙŠØ§ Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯ - ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©!");
    setupVotesListener();
  } 
  else if(value === "451125"){
    adminLevel = 2;
    document.getElementById("lock-screen").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("admin-level-badge").textContent = "ğŸ‘ Ù…Ø±Ø§Ù‚Ø¨";
    showNotification("Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙ‰ Ø¹Ø§Ù„Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©");
    
    document.getElementById("btn-reset-all").classList.add("btn-hidden");
    document.querySelectorAll(".btn-mini-edit").forEach(btn => btn.classList.add("btn-hidden"));
    document.getElementById("edit-col").classList.add("hidden");

    setupVotesListener();
  } 
  else {
    err.textContent = "ÙƒÙ„Ù…Ø© Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    err.style.display = "block";
    setTimeout(() => err.style.display = "none", 2300);
  }
};

document.getElementById("lock-pass").addEventListener("keydown", e => {
  if(e.key === "Enter") unlockDashboard();
});

function showNotification(msg){
  const box = document.createElement("div");
  box.style.cssText = "position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:99999;font-size:1em;max-width:300px;";
  box.innerText = msg;
  document.body.appendChild(box);
  setTimeout(() => box.remove(), 4000);
}

let votesListener = null;

function setupVotesListener() {
  if (votesListener) votesListener();

  const votesRef = ref(db, "/");

  votesListener = onValue(votesRef, snapshot => {
    const root = snapshot.val() || {};
    let combined = {};

    if (root.votes) {
      Object.entries(root.votes).forEach(([id, v]) => { combined[id] = v; });
    }

    if (root.aziza) {
      Object.entries(root.aziza).forEach(([id, v]) => { combined[id] = v; });
    }

    allVotes = Object.entries(combined).map(([id, v], i) => ({
      id,
      index: i + 1,
      name: v.name || "No Name",
      candidates: Array.isArray(v.selected) ? v.selected : [],
      validity: v.vote_validity || "",
      timestamp: v.timestamp || 0,
      committee: Number(v.committee) || 0
    }));

    renderAll();
  });
}

function renderAll(){
  renderStats();
  renderCommitteeStats();
  renderCharts();
  renderRanking();
  renderTable();
}

function renderStats(){
  const total = allVotes.length;
  const valid = allVotes.filter(v => v.validity === "ØµØ­ÙŠØ­").length;
  const invalid = allVotes.filter(v => v.validity === "Ø¨Ø§Ø·Ù„").length;
  const remaining = totalOriginalVoters - total;

  document.getElementById("total-original-voters").textContent = totalOriginalVoters;
  document.getElementById("total-votes").textContent = total;
  document.getElementById("valid-votes").textContent = valid;
  document.getElementById("invalid-votes").textContent = invalid;
  document.getElementById("remaining-voters").textContent = remaining < 0 ? 0 : remaining;

  const liveTxt = document.getElementById("live-status");
  const now = Date.now();

  if(total > 0){
    const sorted = [...allVotes].filter(v => v.timestamp).sort((a, b) => a.timestamp - b.timestamp);
    if(sorted.length === 0){
      document.getElementById("vpm").textContent = "0";
      document.getElementById("vpm10").textContent = "0";
      liveTxt.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØª Ø­Ø§Ù„ÙŠØ§Ù‹";
      return;
    }

    const firstTs = sorted[0].timestamp;
    const lastTs = sorted[sorted.length - 1].timestamp;
    const diffMin = (lastTs - firstTs) / 60000;
    let vpm = diffMin > 0 ? (total / diffMin) : 0;
    document.getElementById("vpm").textContent = vpm.toFixed(2);

    const tenMinAgo = now - (10 * 60 * 1000);
    const last10 = allVotes.filter(v => v.timestamp >= tenMinAgo);
    let vpm10 = 0;
    if(last10.length > 0){
      const firstInWindow = Math.min(...last10.map(x => x.timestamp));
      const span = (now - firstInWindow) / 60000;
      vpm10 = last10.length / (span || 1);
    }
    document.getElementById("vpm10").textContent = vpm10.toFixed(2);

    if(now - lastTs < 25000) liveTxt.textContent = "Ù†Ø´Ø§Ø· Ø¹Ø§Ù„ÙŠ";
    else liveTxt.textContent = "Ù†Ø´Ø§Ø· Ù…Ø³ØªÙ‚Ø±";

    const lastMin = allVotes.filter(v => v.timestamp >= (now - 60000)).length;
    if(total >= 5 && vpm10 > 0 && lastMin >= 3 && lastMin > (vpm10 * 2)){
      document.getElementById("spike-alert").style.display = "block";
    } else {
      document.getElementById("spike-alert").style.display = "none";
    }
  } else {
    document.getElementById("vpm").textContent = "0";
    document.getElementById("vpm10").textContent = "0";
    liveTxt.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØª Ø­Ø§Ù„ÙŠØ§Ù‹";
  }
}

function renderCommitteeStats(){
  const grid = document.getElementById("committee-grid");
  const commData = {};
  
  for(let i = 1; i <= 60; i++){
    commData[i] = { 
      original: originalVotersCount[i] || 0, 
      total: 0, 
      valid: 0, 
      invalid: 0, 
      votes: [], 
      lastVoteValidity: null 
    };
  }
  
  allVotes.forEach(v => {
    const comm = v.committee || 0;
    if(comm >= 1 && comm <= 60){
      commData[comm].total++;
      commData[comm].votes.push(v);
      if(v.validity === "ØµØ­ÙŠØ­") commData[comm].valid++;
      if(v.validity === "Ø¨Ø§Ø·Ù„") commData[comm].invalid++;
      commData[comm].lastVoteValidity = v.validity;
    }
  });
  
  grid.innerHTML = "";
  for(let i = 1; i <= 60; i++){
    const data = commData[i];
    const info = committeeData[i] || { name: "Ù„Ø¬Ù†Ø©", address: "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†" };
    const remaining = data.original - data.total;
    const item = document.createElement("div");
    item.className = "committee-item";
    item.dataset.committee = i;
    
    if(data.lastVoteValidity === "ØµØ­ÙŠØ­"){
      item.style.background = "linear-gradient(135deg, rgba(17, 153, 142, 0.15) 0%, rgba(150, 249, 123, 0.15) 100%)";
      item.style.borderLeft = "4px solid #11998e";
    } else if(data.lastVoteValidity === "Ø¨Ø§Ø·Ù„"){
      item.style.background = "linear-gradient(135deg, rgba(235, 51, 73, 0.15) 0%, rgba(244, 92, 67, 0.15) 100%)";
      item.style.borderLeft = "4px solid #eb3349";
    } else {
      item.style.background = "linear-gradient(135deg, #f5f7ff 0%, #eff2ff 100%)";
      item.style.borderLeft = "4px solid #667eea";
    }
    
    item.onclick = () => showCommitteeDetails(i, data);
    item.innerHTML = "<div class='committee-num'>Ø§Ù„Ù„Ø¬Ù†Ø© " + i + "</div><div class='committee-name'>" + info.name + "</div><div class='committee-address'>" + info.address + "</div><div class='committee-count'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + data.original + "</div><div class='committee-count'>Ø§Ù„Ù…Ø³Ø¬Ù„: " + data.total + "</div><div class='committee-count'>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: " + (remaining < 0 ? 0 : remaining) + "</div>";
    grid.appendChild(item);
  }
}

window.showCommitteeDetails = function(num, data){
  const popup = document.getElementById("committee-popup");
  const title = document.getElementById("committee-popup-title");
  const body = document.getElementById("committee-popup-body");
  const info = committeeData[num] || { name: "Ù„Ø¬Ù†Ø©", address: "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†" };
  const originalCount = data.original || 0;
  const remaining = originalCount - data.total;
  
  title.textContent = info.name + " " + num;
  
  const ourVotes = data.votes.filter(v => v.candidates.includes("Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰")).length;
  const theirVotes = data.total - ourVotes;
  const percentage = data.total > 0 ? ((ourVotes / data.total) * 100).toFixed(1) : 0;
  const now = Date.now();
  
  let vpm = 0;
  const sorted = [...data.votes].filter(v => v.timestamp).sort((a, b) => a.timestamp - b.timestamp);
  if(sorted.length > 0){
    const firstTs = sorted[0].timestamp;
    const lastTs = sorted[sorted.length - 1].timestamp;
    const diffMin = (lastTs - firstTs) / 60000;
    if(diffMin > 0) vpm = data.total / diffMin;
  }
  
  let vpm10 = 0;
  const tenMinAgo = now - (10 * 60 * 1000);
  const last10 = data.votes.filter(v => v.timestamp >= tenMinAgo);
  if(last10.length > 0){
    const firstInWindow = Math.min(...last10.map(x => x.timestamp));
    const span = (now - firstInWindow) / 60000;
    vpm10 = last10.length / (span || 1);
  }
  
  let html = "<div style='background:#f5f7ff;padding:15px;border-radius:12px;margin-bottom:15px;border-left:4px solid #667eea;'>";
  html += "<div style='margin-bottom:8px;font-size:0.9em;color:#667eea;font-weight:700;'>" + info.address + "</div>";
  html += "<div style='display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;'>";
  html += "<div><small style='color:#999;font-weight:600;'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ†</small><div style='font-size:1.5em;font-weight:900;color:#667eea;'>" + originalCount + "</div></div>";
  html += "<div><small style='color:#999;font-weight:600;'>Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</small><div style='font-size:1.5em;font-weight:900;color:#11998e;'>" + data.total + "</div></div>";
  html += "<div><small style='color:#999;font-weight:600;'>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><div style='font-size:1.5em;font-weight:900;color:#eb3349;'>" + (remaining < 0 ? 0 : remaining) + "</div></div>";
  html += "</div><div style='margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;'>";
  html += "<div><small style='color:#11998e;font-weight:600;'>Ø£ØµÙˆØ§Øª ØµØ­ÙŠØ­Ø©</small><div style='font-size:1.3em;font-weight:900;color:#11998e;'>" + data.valid + "</div></div>";
  html += "<div><small style='color:#eb3349;font-weight:600;'>Ø£ØµÙˆØ§Øª Ø¨Ø§Ø·Ù„Ø©</small><div style='font-size:1.3em;font-weight:900;color:#eb3349;'>" + data.invalid + "</div></div></div></div>";
  html += "<div style='background:#e8f5e9;padding:12px;border-radius:10px;margin-bottom:15px;border-left:4px solid #11998e;'>";
  html += "<small style='color:#11998e;font-weight:600;'>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£ØµÙˆØ§Øª/Ø¯Ù‚ÙŠÙ‚Ø©</small><div style='font-size:1.5em;font-weight:900;color:#11998e;'>" + vpm.toFixed(2) + "</div></div>";
  html += "<div style='background:#fff3e0;padding:12px;border-radius:10px;margin-bottom:15px;border-left:4px solid #ff9800;'>";
  html += "<small style='color:#e65100;font-weight:600;'>Ø¢Ø®Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚</small><div style='font-size:1.5em;font-weight:900;color:#e65100;'>" + vpm10.toFixed(2) + "</div></div>";
  html += "<div style='background:#d4fc79;padding:12px;border-radius:10px;margin-bottom:15px;text-align:center;border-left:4px solid #2d5016;'>";
  html += "<small style='color:#2d5016;font-weight:600;'>Ø£ØµÙˆØ§ØªÙ†Ø§</small><div style='font-size:1.8em;font-weight:900;color:#2d5016;'>" + ourVotes + " (" + percentage + "%)</div></div>";
  html += "<div style='background:#ffb347;padding:12px;border-radius:10px;margin-bottom:15px;text-align:center;border-left:4px solid #5c2e0f;'>";
  html += "<small style='color:#5c2e0f;font-weight:600;'>Ø£ØµÙˆØ§Øª Ø£Ø®Ø±Ù‰</small><div style='font-size:1.8em;font-weight:900;color:#5c2e0f;'>" + theirVotes + "</div></div>";
  
  if(data.votes.length > 0){
    html += "<h4 style='color:#667eea;margin:15px 0 10px 0;font-weight:900;'>Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ† (" + data.votes.length + ")</h4>";
    html += "<div style='max-height:300px;overflow-y:auto;'>";
    data.votes.forEach((v, i) => {
      const ourVote = v.candidates.includes("Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰");
      const statusLabel = ourVote ? "ØªØ¨Ø¹Ù†Ø§" : "Ù…Ø´ ØªØ¨Ø¹Ù†Ø§";
      const validityIcon = v.validity === "ØµØ­ÙŠØ­" ? "âœ“" : "âœ—";
      const bgColor = ourVote ? "rgba(212,252,121,0.2)" : "rgba(255,179,71,0.2)";
      const borderColor = ourVote ? "#96f97b" : "#ffb347";
      html += "<div style='padding:10px;margin-bottom:8px;background:" + bgColor + ";border-radius:10px;border-right:4px solid " + borderColor + ";'>";
      html += "<div style='font-weight:700;color:#333;margin-bottom:4px;'>" + (i + 1) + ". " + v.name + "</div>";
      html += "<div style='font-size:0.85em;color:#666;margin-bottom:4px;'>Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†: " + (v.candidates.join(" Ùˆ ") || "â€”") + "</div>";
      html += "<div style='display:flex;gap:8px;font-size:0.85em;'>";
      html += "<span style='padding:3px 8px;background:" + (v.validity === "ØµØ­ÙŠØ­" ? "#c8e6c9" : "#ffccbc") + ";border-radius:6px;color:#333;font-weight:700;'>" + validityIcon + " " + v.validity + "</span>";
      html += "<span style='padding:3px 8px;background:#e8f5e9;border-radius:6px;color:#333;'>" + statusLabel + "</span></div></div>";
    });
    html += "</div>";
  } else {
    html += "<p style='color:#999;text-align:center;padding:20px;background:#f5f7ff;border-radius:10px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆØ§Øª</p>";
  }
  
  body.innerHTML = html;
  popup.classList.remove("hidden");
};

window.closeCommitteePopup = function(){
  document.getElementById("committee-popup").classList.add("hidden");
};

function renderCharts(){
  const ctx1 = document.getElementById("chartCandidates");
  const ctx2 = document.getElementById("chartValidity");
  const ctx3 = document.getElementById("chartVPM");

  if(!ctx1 || !ctx2 || !ctx3) return;

  const counts = {};
  allVotes.forEach(v => v.candidates.forEach(c => counts[c] = (counts[c] || 0) + 1));
  const labels = Object.keys(counts).length > 0 ? Object.keys(counts) : ["Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"];
  const data = Object.keys(counts).length > 0 ? Object.values(counts) : [0];

  if(chartCandidates){
    chartCandidates.destroy();
  }
  chartCandidates = new Chart(ctx1.getContext("2d"), {
    type: "bar",
    data: { labels: labels, datasets: [{ label: "Ø§Ù„Ø£ØµÙˆØ§Øª", data: data, backgroundColor: "#667eea", borderRadius: 8 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  const valid = allVotes.filter(v => v.validity === "ØµØ­ÙŠØ­").length;
  const invalid = allVotes.filter(v => v.validity === "Ø¨Ø§Ø·Ù„").length;
  const total = valid + invalid;

  if(chartValidity){
    chartValidity.destroy();
  }
  chartValidity = new Chart(ctx2.getContext("2d"), {
    type: "doughnut",
    data: { 
      labels: ["ØµØ­ÙŠØ­ (" + valid + ")", "Ø¨Ø§Ø·Ù„ (" + invalid + ")"], 
      datasets: [{ data: total > 0 ? [valid, invalid] : [0, 0], backgroundColor: ["#11998e", "#eb3349"] }] 
    },
    options: { responsive: true, maintainAspectRatio: false, cutout: "55%", plugins: { legend: { position: "bottom" } } }
  });

  const minutes = {};
  allVotes.forEach(v => {
    if(!v.timestamp) return;
    const key = Math.floor(v.timestamp / 60000) * 60000;
    minutes[key] = (minutes[key] || 0) + 1;
  });

  const minuteKeys = Object.keys(minutes).map(Number).sort((a, b) => a - b);
  const minuteLabels = minuteKeys.length > 0 ? minuteKeys.map(t => new Date(t).toLocaleTimeString("ar-EG", { hour: "2-digit", minute: "2-digit" })) : ["Ù„Ø§ ØªÙˆØ¬Ø¯"];
  const minuteData = minuteKeys.length > 0 ? minuteKeys.map(k => minutes[k]) : [0];

  if(chartVPM){
    chartVPM.destroy();
  }
  chartVPM = new Chart(ctx3.getContext("2d"), {
    type: "line",
    data: { labels: minuteLabels, datasets: [{ label: "Ø£ØµÙˆØ§Øª/Ø¯Ù‚ÙŠÙ‚Ø©", data: minuteData, borderColor: "#667eea", backgroundColor: "rgba(102,126,234,0.1)", tension: 0.3, fill: true, pointRadius: 5 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
  });
}

function renderRanking(){
  const list = document.getElementById("ranking-list");
  const counts = {};
  allVotes.forEach(v => v.candidates.forEach(c => counts[c] = (counts[c] || 0) + 1));
  const sorted = Object.entries(counts).map(([name, count]) => ({ name, count })).sort((a, b) => b.count - a.count);

  if(sorted.length === 0){
    list.innerHTML = "<div style='padding:20px;text-align:center;color:#999'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>";
    return;
  }

  const max = sorted[0].count;
  list.innerHTML = sorted.map((c, i) => {
    const rank = i + 1;
    let medal = "ğŸ¥‡";
    if(rank === 2) medal = "ğŸ¥ˆ";
    else if(rank === 3) medal = "ğŸ¥‰";
    else medal = rank;
    const width = Math.max((c.count / max) * 100, 12);
    return "<div class='ranking-item'><div class='ranking-left'><div class='ranking-medal'>" + medal + "</div><div class='ranking-name'>" + c.name + "</div></div><div class='ranking-right'><div class='ranking-bar' style='width:" + width + "%'>" + c.count + "</div><div class='ranking-count'>" + c.count + "</div></div></div>";
  }).join("");
}

function renderTable(){
  const body = document.getElementById("votes-table");
  const note = document.getElementById("footer-note");
  const search = document.getElementById("search").value.toLowerCase().trim();

  let filtered = [...allVotes];
  if(search) filtered = filtered.filter(v => (v.name || "").toLowerCase().includes(search) || v.candidates.join(" ").toLowerCase().includes(search));

  filtered.sort((a, b) => {
    const dir = (sortState.dir === "asc" ? 1 : -1);
    let av = a[sortState.key];
    let bv = b[sortState.key];
    if(sortState.key === "candidates"){ av = a.candidates.join(","); bv = b.candidates.join(","); }
    if(av < bv) return -1 * dir;
    if(av > bv) return 1 * dir;
    return 0;
  });

  body.innerHTML = "";
  filtered.forEach((v, i) => {
    const tr = document.createElement("tr");
    const ourVote = v.candidates.includes("Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰");
    const statusLabel = ourVote ? '<span class="vote-status-friend">ØªØ¨Ø¹Ù†Ø§</span>' : '<span class="vote-status-enemy">Ù…Ø´ ØªØ¨Ø¹Ù†Ø§</span>';
    const editBtn = adminLevel === 1 ? '<button class="btn-mini-edit" onclick="openEdit(\'' + v.id + '\')">ØªØ¹Ø¯ÙŠÙ„</button>' : '';
    tr.innerHTML = "<td>" + (i + 1) + "</td><td class='clickable-name' onclick=\"showDetails('" + v.id + "')\">" + v.name + "</td><td>" + (v.candidates.join(" Ùˆ ") || "â€”") + "</td><td class='" + (v.validity === "ØµØ­ÙŠØ­" ? "status-valid" : "status-invalid") + "'>" + v.validity + "</td><td>" + statusLabel + "</td><td>" + (v.timestamp ? new Date(v.timestamp).toLocaleTimeString("ar-EG", { hour: "2-digit", minute: "2-digit", second: "2-digit" }) : "â€”") + "</td><td>" + editBtn + "</td>";
    body.appendChild(tr);
  });

  note.textContent = filtered.length === 0 ? (allVotes.length === 0 ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬") : "Ø¹Ø±Ø¶ " + filtered.length + " Ù…Ù† " + allVotes.length;
}

document.querySelectorAll("th[data-sort]").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.getAttribute("data-sort");
    if(sortState.key === key) sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
    else { sortState.key = key; sortState.dir = "asc"; }
    renderTable();
  });
});

document.getElementById("search").addEventListener("input", renderTable);
window.showDetails = function(id){
  const v = allVotes.find(x => x.id === id);
  if(!v) return;

  const body = document.getElementById("details-body");
  const time = v.timestamp 
    ? new Date(v.timestamp).toLocaleTimeString("ar-EG", { hour: "2-digit", minute: "2-digit", second: "2-digit" }) 
    : "â€”";

  const chosen = v.candidates.join(" Ùˆ ") || "â€”";
  const isOur = v.candidates.includes("Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰");

  body.innerHTML = `
    <table style='width:100%;'>
      <tr><td><b>Ø§Ù„Ø§Ø³Ù…</b></td><td>${v.name}</td></tr>
      <tr><td><b>Ø§Ù„Ù„Ø¬Ù†Ø©</b></td><td>${v.committee || "â€”"}</td></tr>
      <tr><td><b>Ø§Ù„ÙˆÙ‚Øª</b></td><td>${time}</td></tr>
      <tr><td><b>Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</b></td><td>${chosen}</td></tr>
      <tr>
        <td><b>Ø§Ù„Ø­Ø§Ù„Ø©</b></td>
        <td style='color:${v.validity === "ØµØ­ÙŠØ­" ? "#11998e" : "#eb3349"}'>
          ${v.validity}
        </td>
      </tr>
    </table>

    <div style="
      display:inline-block;
      margin-top:12px;
      padding:8px 14px;
      border-radius:50px;
      background:${isOur ? "#d4fc79" : "#ffb347"};
      color:${isOur ? "#2d5016" : "#5c2e0f"};
      font-weight:700;">
      ${isOur ? "ØªØ¨Ø¹Ù†Ø§" : "Ù…Ø´ ØªØ¨Ø¹Ù†Ø§"}
    </div>
  `;
};


window.openEdit = function(id){
  if(adminLevel !== 1){ alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©"); return; }
  const pw = prompt("Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
  if(pw !== "742018") return alert("ÙƒÙ„Ù…Ø© Ø³Ø± Ø®Ø§Ø·Ø¦Ø©");
  const v = allVotes.find(x => x.id === id);
  if(!v) return;
  window.editID = id;
  document.getElementById("edit-name").textContent = "Ø§Ù„Ù†Ø§Ø®Ø¨: " + v.name;
  const box = document.getElementById("edit-candidates");
  box.innerHTML = "";
  candidatesNames.forEach(c => {
    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.value = c;
    chk.checked = v.candidates.includes(c);
    chk.addEventListener("change", () => {
      const checked = box.querySelectorAll("input:checked");
      if(checked.length > 2){ chk.checked = false; alert("Ù…Ø±Ø´Ø­ÙŠÙ† ÙÙ‚Ø·"); }
    });
    const lbl = document.createElement("label");
    lbl.innerHTML = "<span>" + c + "</span>";
    lbl.appendChild(chk);
    box.appendChild(lbl);
  });
  document.getElementById("edit-popup").classList.remove("hidden");
};

window.closeEdit = function(){
  document.getElementById("edit-popup").classList.add("hidden");
};

window.saveEdit = function(){
  const box = document.getElementById("edit-candidates");
  const checked = [...box.querySelectorAll("input:checked")].map(x => x.value);
  if(checked.length === 0) return alert("Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯");
  if(checked.length > 2) return alert("Ù…Ø±Ø´Ø­ÙŠÙ† ÙÙ‚Ø·");
  update(ref(db, "votes/" + window.editID), { selected: checked })
    .then(() => { showNotification("ØªÙ… Ø§Ù„Ø­ÙØ¸"); closeEdit(); })
    .catch(() => alert("Ø®Ø·Ø£"));
};

window.exportCSV = function(){
  if(allVotes.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");
  
  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Excel Ø¨ØµÙŠØºØ© HTML
  let html = '<table border="1" style="border-collapse: collapse; font-family: Arial; direction: rtl;">';
  html += '<thead style="background-color: #667eea; color: white; font-weight: bold;">';
  html += '<tr>';
  html += '<th style="padding: 10px; text-align: center;">Ø§Ù„ØªØ±ØªÙŠØ¨</th>';
  html += '<th style="padding: 10px; text-align: center;">Ø§Ù„Ø§Ø³Ù…</th>';
  html += '<th style="padding: 10px; text-align: center;">Ø§Ù„Ù„Ø¬Ù†Ø©</th>';
  html += '<th style="padding: 10px; text-align: center;">Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</th>';
  html += '<th style="padding: 10px; text-align: center;">ØµØ­Ø© Ø§Ù„ØµÙˆØª</th>';
  html += '<th style="padding: 10px; text-align: center;">Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª</th>';
  html += '<th style="padding: 10px; text-align: center;">Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>';
  html += '</tr>';
  html += '</thead>';
  html += '<tbody>';
  
  allVotes.forEach((v, i) => {
    const ourVote = v.candidates.includes("Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰");
    const status = ourVote ? "ØªØ¨Ø¹Ù†Ø§ âœ“" : "Ù…Ø´ ØªØ¨Ø¹Ù†Ø§ âœ—";
    const time = v.timestamp ? new Date(v.timestamp).toLocaleString("ar-EG") : "â€”";
    const validity = v.validity === "ØµØ­ÙŠØ­" ? "âœ“ ØµØ­ÙŠØ­" : "âœ— Ø¨Ø§Ø·Ù„";
    const bgColor = i % 2 === 0 ? "#f9f9f9" : "#ffffff";
    
    html += '<tr style="background-color: ' + bgColor + ';">';
    html += '<td style="padding: 8px; text-align: center;">' + (i + 1) + '</td>';
    html += '<td style="padding: 8px; text-align: right;">' + v.name + '</td>';
    html += '<td style="padding: 8px; text-align: center;">' + (v.committee || "â€”") + '</td>';
    html += '<td style="padding: 8px; text-align: right;">' + (v.candidates.join(" Ùˆ ") || "â€”") + '</td>';
    html += '<td style="padding: 8px; text-align: center; color: ' + (v.validity === "ØµØ­ÙŠØ­" ? "#11998e" : "#eb3349") + '; font-weight: bold;">' + validity + '</td>';
    html += '<td style="padding: 8px; text-align: center; background-color: ' + (ourVote ? "#d4fc79" : "#ffb347") + '; color: ' + (ourVote ? "#2d5016" : "#5c2e0f") + '; font-weight: bold;">' + status + '</td>';
    html += '<td style="padding: 8px; text-align: center;">' + time + '</td>';
    html += '</tr>';
  });
  
  html += '</tbody>';
  html += '</table>';
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel
  const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Ø§Ù„Ø£ØµÙˆØ§Øª_" + new Date().toLocaleDateString("ar-EG") + ".xls";
  a.click();
  URL.revokeObjectURL(url);
  showNotification("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ“");
};

window.resetAll = function(){
  if(adminLevel !== 1){ alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©"); return; }
  const pw = prompt("Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
  if(pw !== "742018") return alert("Ø®Ø·Ø£");
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) return;
  remove(ref(db, "votes"))
    .then(() => { showNotification("ØªÙ…"); allVotes = []; renderAll(); })
    .catch(() => alert("Ø®Ø·Ø£"));
};

window.sendNotification = async function(){
  const txt = document.getElementById("notify-message").value.trim();
  const result = document.getElementById("notify-result");

  if(!txt){
    result.style.display = "block";
    result.style.color = "#eb3349";
    result.textContent = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©";
    return;
  }

  const mode = document.querySelector("input[name='notify-target']:checked").value;
  let topic = "all";

  if(mode === "one"){
    const num = Number(document.getElementById("notify-committee").value);
    if(num < 1 || num > 60){
      result.style.display = "block";
      result.style.color = "#eb3349";
      result.textContent = "Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø© ØºÙŠØ± ØµØ­ÙŠØ­ (1-60)";
      return;
    }
    topic = "committee_" + num;
  }

  result.style.display = "block";
  result.style.color = "#667eea";
  result.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

  try {
    const timestamp = Date.now();
    const messageRef = ref(db, "notifications/" + topic + "/" + timestamp);
    await set(messageRef, {
      message: txt,
      topic: topic,
      timestamp: timestamp,
      sentAt: new Date().toISOString(),
      type: "dashboard_notification"
    });
    result.style.color = "#11998e";
    result.textContent = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ " + (mode === "all" ? "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø¬Ø§Ù† âœ“" : ("Ø§Ù„Ù„Ø¬Ù†Ø© " + document.getElementById("notify-committee").value + " âœ“"));
    document.getElementById("notify-message").value = "";
    setTimeout(() => result.style.display = "none", 3500);
  } catch(err){
    result.style.color = "#eb3349";
    result.textContent = "Ø®Ø·Ø£: " + err.message;
    console.error("Notification error:", err);
    setTimeout(() => result.style.display = "none", 4000);
  }
};

</script>
</body>
</html>


