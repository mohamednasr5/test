<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { margin: 0; padding: 20px; font-family: "Cairo", sans-serif; background-color: #0f0f1a; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
  
  /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; width: 90%; max-width: 800px; margin-bottom: 25px; }
  
  .stat-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.3s; }
  .stat-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); }
  
  .stat-title { font-size: 0.9em; color: #ccc; margin-bottom: 10px; font-weight: bold; }
  .stat-value { font-size: 3rem; font-weight: 900; line-height: 1; }
  
  /* Ø£Ù„ÙˆØ§Ù† Ù…Ù…ÙŠØ²Ø© Ù„Ù„Ø£Ø±Ù‚Ø§Ù… */
  .color-online { background: linear-gradient(to bottom, #00f2fe 0%, #4facfe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .color-total { background: linear-gradient(to bottom, #f093fb 0%, #f5576c 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .color-valid { background: linear-gradient(to bottom, #43e97b 0%, #38f9d7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .color-invalid { background: linear-gradient(to bottom, #ff0844 0%, #ffb199 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

  /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
  .msg-card { background: #fff; color: #333; width: 90%; max-width: 600px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; }
  h2 { margin: 0 0 15px 0; color: #4facfe; text-align: center; }
  .msg-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; font-family: inherit; box-sizing: border-box; margin-bottom: 10px; }
  .send-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; }
  
  .quick-replies { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
  .template-btn { background: #f0f2f5; border: none; padding: 10px; border-radius: 8px; cursor: pointer; text-align: right; transition: 0.2s; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
  .template-btn:hover { background: #e0e7ff; color: #4facfe; }

  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„ */
  .log-container { width: 90%; max-width: 800px; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 20px; border: 1px solid #333; }
  .log-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
  .log-table th { text-align: right; padding: 10px; border-bottom: 2px solid #444; color: #888; }
  .log-table td { padding: 12px 10px; border-bottom: 1px solid #333; vertical-align: middle; }
  .log-row { transition: 0.3s; animation: fadeIn 0.5s ease; }
  .log-row:hover { background: rgba(255,255,255,0.05); }
  .status-badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.8em; }
  .status-valid { background: rgba(46, 125, 50, 0.2); color: #66bb6a; border: 1px solid #2e7d32; }
  .status-invalid { background: rgba(198, 40, 40, 0.2); color: #ef5350; border: 1px solid #c62828; }
  .candidate-pill { display: inline-block; background: #222; border: 1px solid #444; padding: 2px 8px; border-radius: 10px; margin: 2px; font-size: 0.85em; }
  
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-title">Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù† ğŸ”´</div>
        <div class="stat-value color-online" id="online-count">0</div>
        <div style="font-size:0.7em; color:#666;">ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
    </div>

    <div class="stat-card">
        <div class="stat-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª ğŸ—³ï¸</div>
        <div class="stat-value color-total" id="total-votes">0</div>
    </div>

    <div class="stat-card">
        <div class="stat-title">Ø£ØµÙˆØ§Øª ØµØ­ÙŠØ­Ø© âœ…</div>
        <div class="stat-value color-valid" id="valid-votes">0</div>
    </div>

    <div class="stat-card">
        <div class="stat-title">Ø£ØµÙˆØ§Øª Ø¨Ø§Ø·Ù„Ø© âŒ</div>
        <div class="stat-value color-invalid" id="invalid-votes">0</div>
    </div>
</div>

<div class="msg-card">
  <h2>ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
  <input type="text" id="msg-input" class="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹...">
  <button class="send-btn" id="send-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ ğŸš€</button>
  <div style="display:none; text-align:center; color:green; margin-top:5px;" id="status-msg">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!</div>
  
  <div class="quick-replies">
      <div style="font-size:0.8em; color:#999; font-weight:bold; margin-bottom:5px;">Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø§Ù‡Ø²Ø©:</div>
      <button class="template-btn" onclick="fillMsg('Ø§Ù‡Ù„Ø§ ÙˆÙ…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙ‰ Ù…Ø¤ØªÙ…Ø± Ø¯Ø¹Ù… Ø§Ù„Ø­Ø§Ø¬ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠ')">
          <span>ğŸ‘‹</span> Ø§Ù‡Ù„Ø§ ÙˆÙ…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙ‰ Ù…Ø¤ØªÙ…Ø± Ø¯Ø¹Ù… Ø§Ù„Ø­Ø§Ø¬ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠ
      </button>
      <button class="template-btn" onclick="fillMsg('Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙŠØ§Ø±ÙŠØª ÙƒÙ„Ù†Ø§ Ù†Ù‡ØªÙ… Ø´ÙˆÙŠØ© ÙŠØ§Ø¬Ù…Ø§Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ø°Ù†ÙƒÙ…')">
          <span>âš ï¸</span> Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙŠØ§Ø±ÙŠØª ÙƒÙ„Ù†Ø§ Ù†Ù‡ØªÙ… Ø´ÙˆÙŠØ© ÙŠØ§Ø¬Ù…Ø§Ø¹Ø©
      </button>
      <button class="template-btn" onclick="fillMsg('Ø´ÙƒØ±Ø§ Ù„ØªØ¹Ø¨ÙƒÙ… ÙˆØ¯Ø¹Ù…ÙƒÙ… Ù„Ù„Ø­Ø§Ø¬ Ø§Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠ')">
          <span>â¤ï¸</span> Ø´ÙƒØ±Ø§ Ù„ØªØ¹Ø¨ÙƒÙ… ÙˆØ¯Ø¹Ù…ÙƒÙ… Ù„Ù„Ø­Ø§Ø¬ Ø§Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠ
      </button>
  </div>
</div>

<div class="log-container">
    <h3 style="margin:0 0 15px 0; color:#fff;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
    <table class="log-table">
        <thead>
            <tr>
                <th>Ø§Ù„Ù†Ø§Ø®Ø¨ / Ø§Ù„ÙˆÙ‚Øª</th>
                <th>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody id="log-body"></tbody>
    </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, query, limitToLast, onChildAdded } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAoZE2KL3APojd929VEbhSv914jzDv90wA",
    authDomain: "test-dd8b4.firebaseapp.com",
    databaseURL: "https://test-dd8b4-default-rtdb.firebaseio.com",
    projectId: "test-dd8b4",
    storageBucket: "test-dd8b4.firebasestorage.app",
    messagingSenderId: "761689441004",
    appId: "1:761689441004:web:667a3fae42f3cf84071bc9",
    measurementId: "G-PP1BG203MT"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù† (Online Users)
  // Ù†Ø³ØªÙ…Ø¹ Ù„Ù„Ø¹Ù‚Ø¯Ø© presenceØŒ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø¯Ø§Ø®Ù„Ù‡Ø§ ÙŠÙ…Ø«Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
  onValue(ref(db, 'presence'), (snap) => {
    // snap.size ÙŠØ¹ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†) Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹
    const count = snap.size; 
    document.getElementById("online-count").innerText = count;
  });

  // 2. Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØµÙˆÙŠØª (Total, Valid, Invalid)
  onValue(ref(db, 'votes'), (snap) => {
      let total = 0;
      let valid = 0;
      let invalid = 0;

      snap.forEach((child) => {
          total++;
          const val = child.val();
          if (val.status === "ØµØ­ÙŠØ­") {
              valid++;
          } else {
              invalid++;
          }
      });

      document.getElementById("total-votes").innerText = total;
      document.getElementById("valid-votes").innerText = valid;
      document.getElementById("invalid-votes").innerText = invalid;
  });

  // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  window.fillMsg = function(text) {
      document.getElementById("msg-input").value = text;
  }
  document.getElementById("send-btn").addEventListener("click", () => {
    const input = document.getElementById("msg-input");
    if (!input.value.trim()) return;
    set(ref(db, 'broadcast_message'), { text: input.value.trim(), timestamp: Date.now() });
    input.value = "";
    document.getElementById("status-msg").style.display = "block";
    setTimeout(()=>document.getElementById("status-msg").style.display="none", 2000);
  });

  // 4. Ø³Ø¬Ù„ Ø§Ù„ØªØµÙˆÙŠØª (Live Log)
  const votesRef = query(ref(db, 'votes'), limitToLast(50));
  const logBody = document.getElementById("log-body");

  onChildAdded(votesRef, (snapshot) => {
      const data = snapshot.val();
      if(!data) return;

      const row = document.createElement("tr");
      row.className = "log-row";
      
      const timeStr = new Date(data.timestamp).toLocaleTimeString('ar-EG');
      const statusClass = data.status === "ØµØ­ÙŠØ­" ? "status-valid" : "status-invalid";
      
      let candidatesHtml = "";
      if(data.candidates && Array.isArray(data.candidates)){
          data.candidates.forEach(c => {
              candidatesHtml += `<span class="candidate-pill">${c}</span>`;
          });
      }

      row.innerHTML = `
          <td>
              <span style="font-weight:bold; display:block; color:#fff">${data.name}</span>
              <span style="font-size:0.75em; color:#777">${timeStr}</span>
          </td>
          <td>${candidatesHtml}</td>
          <td><span class="status-badge ${statusClass}">${data.status}</span></td>
      `;
      logBody.prepend(row);
  });
</script>

</body>
</html>
