<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Cairo", "Segoe UI", Tahoma, sans-serif; }
body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; color: #fff; overflow-x: hidden; }
.hidden { display: none !important; }

/* Ø´Ø§Ø´Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± */
#password-modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 9999; }
.pass-box { width: 95%; max-width: 400px; background: #fff; color: #222; padding: 35px 18px; border-radius: 18px; text-align: center; }
.pass-input { 
    width: 100%; 
    padding: 14px; 
    margin-top: 20px; 
    text-align: center; 
    border-radius: 12px; 
    border: 2px solid #e0e7ff; 
    background: #f8f9ff; 
    font-size: 1.5em; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… */
    font-weight: bold;
    letter-spacing: 2px;
    color: #667eea;
}
.pass-btn { margin-top: 20px; width: 100%; padding: 13px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
.pass-err { margin-top: 12px; color: #c62828; display: none; }

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.container { width: 100%; max-width: 420px; background: #fff; color: #222; padding: 26px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: fade 0.5s ease; }
@keyframes fade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
h2 { text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2em; font-weight: 900; margin-bottom: 10px; }
.committee-info { text-align: center; margin: 12px 0 25px; background: #f5f7ff; padding: 12px; border-radius: 12px; border-left: 4px solid #667eea; }
label { font-weight: 700; color: #333; margin-top: 16px; display: block; }
input[type="text"] { width: 100%; padding: 13px 12px; border-radius: 12px; border: 2px solid #e0e7ff; background: #f8f9ff; margin-top: 8px; }
.candidate-list { margin-top: 10px; background: #f8f9ff; border: 2px solid #e0e7ff; border-radius: 14px; max-height: 320px; overflow-y: auto; padding: 8px; }
.candidate-item { background: #fff; border: 1px solid #e8ecff; padding: 10px; margin-bottom: 9px; display: flex; justify-content: space-between; align-items: center; border-radius: 12px; cursor: pointer; border-left: 4px solid #667eea; transition:0.3s;}
.candidate-item.selected { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
.radio-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px; }
.radio-item { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: #fff; border-radius: 10px; border: 2px solid #e0e7ff; }
.radio-item.selected { background: #667eea; color: #fff; }
.btn-row { display: flex; gap: 10px; margin-top: 23px; }
button { flex: 1; padding: 13px; border-radius: 12px; cursor: pointer; border: none; font-weight: bold; }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
.btn-reset { background: #e0e7ff; color: #667eea; }
.action-btn { width: 100%; margin-top: 15px; padding: 13px; background: linear-gradient(135deg, #4c28d3 0%, #7d45ff 100%); color: #fff; font-weight: 700; border-radius: 12px; border: none; cursor: pointer; }
.msg-confirm { display: none; margin-top: 12px; padding: 11px; border-radius: 10px; text-align: center; font-weight: 700; background: #e8f5e9; color: #2e7d32; }

/* Popup Styles */
#admin-msg-popup { position: fixed; bottom: 20px; right: 20px; background: #fff; border-right: 6px solid #ff9800; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 10000; display: flex; align-items: flex-start; gap: 15px; min-width: 320px; max-width: 90vw; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes slideUp { from { bottom: -150px; opacity: 0; } to { bottom: 20px; opacity: 1; } }
.admin-msg-content { color: #333; font-weight: bold; line-height: 1.5; font-size: 1.05em; margin-top: 5px; }
.close-popup { cursor: pointer; color: #aaa; font-size: 1.4em; margin-right: auto; }
#preview-container { margin-top: 15px; display: none; text-align: center; }
#preview-img { max-width: 100%; border-radius: 10px; border: 2px solid #4caf50; padding: 5px; background: #fff; }
</style>
</head>
<body>

<div id="admin-msg-popup" class="hidden">
    <div style="font-size: 2.2em;">ğŸ””</div>
    <div style="flex:1;">
        <div style="font-size: 0.85em; color: #888; font-weight: bold; margin-bottom: 2px;">ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        <div class="admin-msg-content" id="admin-msg-text"></div>
    </div>
    <div class="close-popup" onclick="document.getElementById('admin-msg-popup').classList.add('hidden')">âœ•</div>
</div>

<div id="password-modal">
  <div class="pass-box">
    <h2 class="pass-title" style="font-size:1.5em; margin-bottom:10px;">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠ</h2>
    
    <input type="text" id="password-input" class="pass-input" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (200200)" autocomplete="off">
    
    <button class="pass-btn" id="login-btn">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
    <div id="pw-err" class="pass-err">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
  </div>
</div>

<div class="container hidden" id="main-container">
  <h2 id="welcome-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª</h2>
  <div class="committee-info">
    <div class="committee-name">Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
    <div class="committee-address">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù†Ø´Ø·Ø© ğŸŸ¢</div>
  </div>
  
  <form id="vote-form">
    <label>Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø®Ø¨:</label>
    <input type="text" id="voter-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø®Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    
    <label>Ø§Ø®ØªØ± Ù…Ø±Ø´Ø­ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ):</label>
    <div class="candidate-list" id="candidate-list"></div>
    
    <div class="radio-group">
        <label class="radio-item"><input type="radio" name="vvalid" value="ØµØ­ÙŠØ­"> <span>âœ“ ØµØ­ÙŠØ­</span></label>
        <label class="radio-item"><input type="radio" name="vvalid" value="Ø¨Ø§Ø·Ù„"> <span>âœ— Ø¨Ø§Ø·Ù„</span></label>
    </div>
    
    <div class="btn-row">
      <button type="submit" class="btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª</button>
      <button type="reset" class="btn-reset" onclick="resetStyle()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>
    <div id="msg-confirm" class="msg-confirm"></div>
  </form>

  <div style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 10px;">
    <input type="file" id="file-upload" accept="image/*" style="display: none;" onchange="handleFileUpload(this)">
    <button class="action-btn" id="upload-btn" onclick="document.getElementById('file-upload').click()">
      <span id="upload-text">Ø±ÙØ¹ Ù…Ø­Ø¶Ø± Ø§Ù„Ù„Ø¬Ù†Ø© ğŸ“„</span>
    </button>
    <div id="preview-container"><img id="preview-img" src=""></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAoZE2KL3APojd929VEbhSv914jzDv90wA",
    authDomain: "test-dd8b4.firebaseapp.com",
    databaseURL: "https://test-dd8b4-default-rtdb.firebaseio.com",
    projectId: "test-dd8b4",
    storageBucket: "test-dd8b4.firebasestorage.app",
    messagingSenderId: "761689441004",
    appId: "1:761689441004:web:667a3fae42f3cf84071bc9",
    measurementId: "G-PP1BG203MT"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  document.getElementById("login-btn").addEventListener("click", checkPass);
  
  function checkPass() {
    const val = document.getElementById("password-input").value.trim();
    if (val === "200200") {
      document.getElementById("password-modal").classList.add("hidden");
      document.getElementById("main-container").classList.remove("hidden");
      
      const myPresenceRef = push(ref(db, 'presence'));
      onDisconnect(myPresenceRef).remove();
      set(myPresenceRef, {
          online: true,
          timestamp: Date.now()
      });

      setupMessageListener();
    } else {
      const err = document.getElementById("pw-err");
      err.style.display = "block";
      setTimeout(() => err.style.display = "none", 2000);
    }
  }

  function setupMessageListener() {
    const msgRef = ref(db, 'broadcast_message');
    let firstLoad = true;
    onValue(msgRef, (snapshot) => {
      if (firstLoad) { firstLoad = false; return; }
      const data = snapshot.val();
      if (data && data.text) {
        const popup = document.getElementById("admin-msg-popup");
        document.getElementById("admin-msg-text").textContent = data.text;
        popup.classList.remove("hidden");
        setTimeout(() => popup.classList.add("hidden"), 15000);
      }
    });
  }

  const candidates = [
    ["1", "Ø§ÙŠÙ‡Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø¯Ù‡", "ğŸ‘‘"], ["2", "Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙ…Ø§Ù†Ù‰", "ğŸ"], ["3", "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰", "ğŸ¦"],
    ["4", "Ø¹Ø§Ø¯Ù„ Ø§Ù„Ø¬ÙŠØ§Ø±", "ğŸ¦…"], ["5", "Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø³Ù…Ø±Ù‡", "ğŸ’£"], ["6", "ÙˆÙ„ÙŠØ¯ ØªÙŠØ³ÙŠØ± Ø§Ù„Ø§Ù…ÙŠØ±", "ğŸŠ"],
    ["7", "ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹ÙŠØ³ÙˆÙ‰", "ğŸŒ€"], ["8", "Ø§Ù„Ø¨Ø¯ÙˆÙ‰ Ø¬Ù…ÙŠØ²", "ğŸ‹"], ["9", "Ø§Ø­Ù…Ø¯ Ø§Ù„Ø±ÙŠØ³", "ğŸ¦‚"],
    ["10", "Ø£Ø­Ù…Ø¯ Ø¹ÙˆÙ", "âœ‹"], ["11", "Ø­Ø³Ù† Ø§Ù„Ù…Ù„Ù‡Ø§Ø·", "ğŸŒ¿"], ["12", "Ø¹Ù…Ø±Ùˆ Ù…Ø­Ù…Ø¯ Ø¨Ø­ÙŠØ±Ù‰", "ğŸšŒ"],
    ["13", "Ø§Ù„Ø³ÙŠØ¯ Ø·Ù…Ø§Ù†", "ğŸ”«"], ["14", "Ù…Ø­Ù…Ø¯ Ø¯Ù†Ø¯Ù†", "ğŸš"], ["15", "Ù…Ø¬Ø¯Ù‰ Ø§Ù„Ø£Ù…ÙŠØ±", "ğŸ–Š"]
  ];

  const listBox = document.getElementById("candidate-list");
  candidates.forEach((c) => {
    const item = document.createElement("div");
    item.className = "candidate-item";
    item.innerHTML = `<div style="display:flex; gap:10px; align-items:center"><div style="width:30px; height:30px; background:#667eea; color:#fff; border-radius:50%; display:flex; justify-content:center; align-items:center;">${c[0]}</div><b>${c[1]}</b></div><span style="font-size:1.5em">${c[2]}</span>`;
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = c[1];
    checkbox.className = "candidate-checkbox";
    checkbox.style.marginLeft = "10px";
    item.appendChild(checkbox);
    item.onclick = (e) => { if(e.target !== checkbox) checkbox.click(); };
    checkbox.onchange = updateStyle;
    listBox.appendChild(item);
  });

  function updateStyle() {
    document.querySelectorAll(".candidate-item").forEach(el => {
      const cb = el.querySelector("input");
      if(cb.checked) el.classList.add("selected"); else el.classList.remove("selected");
    });
    const checked = document.querySelectorAll(".candidate-checkbox:checked");
    if(checked.length > 2) {
        checked[checked.length-1].checked = false;
        alert("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±Ø´Ø­ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† ÙÙ‚Ø·");
        updateStyle();
    }
  }
  window.updateStyle = updateStyle;
  window.resetStyle = function() {
      setTimeout(updateStyle, 50);
      document.querySelectorAll(".radio-item").forEach(r => r.classList.remove("selected"));
      resetUploadButton();
  }

  document.querySelectorAll("input[type='radio']").forEach(r => {
      r.addEventListener("change", function() {
          document.querySelectorAll(".radio-item").forEach(x => x.classList.remove("selected"));
          this.closest(".radio-item").classList.add("selected");
      });
  });

  document.getElementById("vote-form").onsubmit = function(e) {
      e.preventDefault();
      
      const voterName = document.getElementById("voter-name").value.trim() || "ÙØ§Ø¹Ù„ Ø®ÙŠØ±";
      const sel = Array.from(document.querySelectorAll(".candidate-checkbox:checked")).map(cb => cb.value);
      const val = document.querySelector("input[name='vvalid']:checked");

      if(sel.length !== 2) return alert("Ø§Ø®ØªØ± Ù…Ø±Ø´Ø­ÙŠÙ† Ø§Ø«Ù†ÙŠÙ†");
      if(!val) return alert("Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª");

      const votesRef = ref(db, 'votes');
      push(votesRef, {
        name: voterName,
        candidates: sel,
        status: val.value,
        timestamp: Date.now()
      }).then(() => {
          const confirmMsg = document.getElementById("msg-confirm");
          confirmMsg.innerText = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…";
          confirmMsg.style.display = "block";
          
          setTimeout(() => {
              confirmMsg.style.display = "none";
              this.reset();
              resetStyle();
          }, 2000);
      }).catch(err => {
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + err.message);
      });
  };

  window.handleFileUpload = function(input) {
    if (input.files && input.files[0]) {
        const btn = document.getElementById("upload-btn");
        document.getElementById("upload-text").innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... â³";
        setTimeout(() => {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-container').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
            btn.style.background = "#28a745";
            document.getElementById("upload-text").innerText = "âœ” ØªÙ… Ø§Ù„Ø±ÙØ¹";
        }, 1500);
    }
  }
  function resetUploadButton() {
      const btn = document.getElementById("upload-btn");
      btn.style.background = "linear-gradient(135deg, #4c28d3 0%, #7d45ff 100%)";
      document.getElementById("upload-text").innerText = "Ø±ÙØ¹ Ù…Ø­Ø¶Ø± Ø§Ù„Ù„Ø¬Ù†Ø© ğŸ“„";
      document.getElementById("preview-container").style.display = 'none';
  }
</script>
</body>
</html>
